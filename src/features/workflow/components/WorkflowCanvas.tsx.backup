"use client";

import React from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Loader2,
  CheckCircle2,
  Sparkles,
  ArrowDown,
  Target,
  RotateCcw,
  AlertCircle,
  ExternalLink,
  GripVertical,
  Plus,
  Edit3,
  Trash2,
  Check,
  X,
  RefreshCw,
  BookOpen,
  FileText,
  Star,
} from "lucide-react";
import { useWorkflowStore } from "../hooks/useWorkflowStore";

export function WorkflowCanvas() {
  const {
    workflowResult,
    isLoading,
    userGoal,
    selectedTask,
    isGeneratingGuides,
    generatedGuides,
    clearWorkflow,
    setWorkflowResult,
    setSelectedTask,
    addTask,
    updateTask,
    deleteTask,
    generateGuides,
    retryGuideGeneration,
  } = useWorkflowStore();
  const [draggedTask, setDraggedTask] = React.useState<string | null>(null);
  const [dragOverTask, setDragOverTask] = React.useState<string | null>(null);
  const [editingTask, setEditingTask] = React.useState<string | null>(null);
  const [editingText, setEditingText] = React.useState("");
  const [isAddingTask, setIsAddingTask] = React.useState(false);
  const [newTaskText, setNewTaskText] = React.useState("");
  const [rematchingTasks, setRematchingTasks] = React.useState<Set<string>>(
    new Set()
  );
  const [layoutMode, setLayoutMode] = React.useState<'horizontal' | 'vertical'>('horizontal');

  const handleNewWorkflow = () => {
    clearWorkflow();
    setLayoutMode('horizontal'); // 레이아웃 모드 리셋
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const handleProceedToGuides = async () => {
    // 레이아웃을 세로 배치로 변경
    setLayoutMode('vertical');
    
    // 가이드 생성 시작
    await generateGuides();
    
    // 가이드 섹션으로 스크롤
    setTimeout(() => {
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }, 100);
  };

  const getWorkflowStatus = () => {
    if (isLoading) return "Analyzing your goal...";
    if (workflowResult) return "Planning completed";
    return "Ready to start";
  };

  const getCompletedTasksCount = () => {
    if (!workflowResult) return 0;
    // Since tasks don't have status, we'll assume all are completed when workflow status is completed
    return workflowResult.status === "completed"
      ? workflowResult.tasks.length
      : 0;
  };

  const getProgressPercentage = () => {
    if (!workflowResult) return 0;
    const completed = getCompletedTasksCount();
    return Math.round((completed / workflowResult.tasks.length) * 100);
  };

  // Task editing handlers
  const handleEditStart = (taskId: string, currentName: string) => {
    setEditingTask(taskId);
    setEditingText(currentName);
  };

  const handleEditSave = () => {
    if (editingTask && editingText.trim()) {
      updateTask(editingTask, editingText.trim());
    }
    setEditingTask(null);
    setEditingText("");
  };

  const handleEditCancel = () => {
    setEditingTask(null);
    setEditingText("");
  };

  const handleAddTask = () => {
    if (newTaskText.trim()) {
      addTask(newTaskText.trim());
      setNewTaskText("");
      setIsAddingTask(false);
    }
  };

  const handleDeleteTask = (taskId: string) => {
    deleteTask(taskId);
  };

  const handleTaskClick = (taskId: string) => {
    if (layoutMode === 'vertical') {
      setSelectedTask(taskId);
    }
  };

  const handleRematchTool = async (taskId: string, taskName: string) => {
    if (!workflowResult) return;

    setRematchingTasks((prev) => new Set(prev).add(taskId));

    try {
      const response = await fetch("/api/workflow/rematch-tool", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          taskId,
          taskName,
          language: "ko", // or get from user preference
        }),
      });

      if (!response.ok) {
        throw new Error("도구 재매칭에 실패했습니다.");
      }

      const result = await response.json();

      // Update the specific task with new tool recommendation
      const updatedTasks = workflowResult.tasks.map((task) =>
        task.id === taskId
          ? {
              ...task,
              recommendedTool: result.recommendedTool,
              recommendationReason: result.recommendationReason,
              confidence: result.confidence,
            }
          : task
      );

      setWorkflowResult({
        ...workflowResult,
        tasks: updatedTasks,
      });
    } catch (error) {
      console.error("Tool rematch failed:", error);
      // You could add a toast notification here
    } finally {
      setRematchingTasks((prev) => {
        const newSet = new Set(prev);
        newSet.delete(taskId);
        return newSet;
      });
    }
  };

  // Drag and Drop handlers
  const handleDragStart = (e: React.DragEvent, taskId: string) => {
    setDraggedTask(taskId);
    e.dataTransfer.effectAllowed = "move";
  };

  const handleDragOver = (e: React.DragEvent, taskId: string) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
    setDragOverTask(taskId);
  };

  const handleDragLeave = () => {
    setDragOverTask(null);
  };

  const handleDrop = (e: React.DragEvent, targetTaskId: string) => {
    e.preventDefault();

    if (!draggedTask || !workflowResult || draggedTask === targetTaskId) {
      setDraggedTask(null);
      setDragOverTask(null);
      return;
    }

    const tasks = [...workflowResult.tasks];
    const draggedIndex = tasks.findIndex((task) => task.id === draggedTask);
    const targetIndex = tasks.findIndex((task) => task.id === targetTaskId);

    if (draggedIndex === -1 || targetIndex === -1) return;

    // Swap the tasks
    const draggedTaskData = tasks[draggedIndex];
    const targetTaskData = tasks[targetIndex];

    // Update order values
    const tempOrder = draggedTaskData.order;
    draggedTaskData.order = targetTaskData.order;
    targetTaskData.order = tempOrder;

    // Swap positions in array
    tasks[draggedIndex] = targetTaskData;
    tasks[targetIndex] = draggedTaskData;

    // Update the workflow result
    setWorkflowResult({
      ...workflowResult,
      tasks: tasks.sort((a, b) => a.order - b.order),
    });

    setDraggedTask(null);
    setDragOverTask(null);
  };

  return (
    <div className="bg-background">
      {/* Canvas Container - Card Style */}
      <div className="w-full px-4 sm:px-6 lg:px-8 xl:px-12 pb-8">
        <div
          className="max-w-none mx-auto bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-slate-800 dark:via-indigo-900 dark:to-purple-900 rounded-3xl shadow-2xl border border-border overflow-hidden 
                       w-[calc(100vw-2rem)] sm:w-[calc(100vw-3rem)] lg:w-[calc(100vw-4rem)] xl:w-[calc(100vw-6rem)]"
        >
          {/* Header - Inside Card */}
          <div className="px-4 sm:px-6 lg:px-8 pt-4 sm:pt-6 pb-4 sm:pb-6 border-b-2 border-white/30 dark:border-slate-600/50 shadow-sm">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-4">
                <div className="flex items-center space-x-2 sm:space-x-3">
                  <div className="w-8 h-8 sm:w-10 sm:h-10 bg-primary rounded-xl flex items-center justify-center shadow-lg">
                    <Sparkles className="w-4 h-4 sm:w-5 sm:h-5 text-primary-foreground" />
                  </div>
                  <h1 className="text-lg sm:text-xl lg:text-2xl font-bold text-foreground">
                    WorkFlow Canvas
                  </h1>
                </div>

                <div className="hidden md:flex items-center space-x-3 bg-white/20 dark:bg-slate-800/50 backdrop-blur-sm rounded-full px-4 py-2">
                  {isLoading ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin text-primary" />
                      <span className="text-sm text-foreground">
                        {getWorkflowStatus()}
                      </span>
                    </>
                  ) : workflowResult ? (
                    <>
                      <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-sm" />
                      <span className="text-sm text-green-600 font-medium">
                        {getWorkflowStatus()}
                      </span>
                    </>
                  ) : (
                    <>
                      <div className="w-2 h-2 bg-slate-500 rounded-full" />
                      <span className="text-sm text-muted-foreground">
                        {getWorkflowStatus()}
                      </span>
                    </>
                  )}
                </div>
              </div>

              <Button
                onClick={handleNewWorkflow}
                variant="outline"
                size="sm"
                className="shadow-lg transition-all duration-200 hover:scale-105 border-white/30 dark:border-slate-600"
              >
                <RotateCcw className="w-4 h-4 sm:mr-2" />
                <span className="hidden sm:inline">New Task</span>
              </Button>
            </div>
          </div>

          {/* Divider */}
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-white/40 dark:border-slate-600/60"></div>
            </div>
            <div className="relative flex justify-center">
              <div className="bg-white/50 dark:bg-slate-700/50 px-4 py-1 rounded-full backdrop-blur-sm">
                <div className="flex space-x-1">
                  <div className="w-2 h-2 bg-indigo-400 rounded-full"></div>
                  <div className="w-2 h-2 bg-purple-400 rounded-full"></div>
                  <div className="w-2 h-2 bg-pink-400 rounded-full"></div>
                </div>
              </div>
            </div>
          </div>

          {/* Content Area - Inside Card */}
          <div className="p-4 sm:p-6 lg:p-8 xl:p-12">
            {/* Loading State - Show main node immediately when loading */}
            {isLoading && (
              <div className="space-y-8">
                {/* Show Main Task Node immediately even during loading */}
                <div className={`flex gap-8 items-start ${
                  layoutMode === 'vertical' 
                    ? 'flex-col' 
                    : 'flex-col lg:flex-row'
                }`}>
                  {/* Main Task Node - Always visible during loading */}
                  <div className={`bg-gradient-to-br from-primary to-primary/80 rounded-2xl p-4 sm:p-6 shadow-2xl border border-primary/20 w-full ${
                    layoutMode === 'vertical' ? 'max-w-none' : 'max-w-sm'
                  }`}>
                    <div className="flex items-center space-x-3 mb-3">
                      <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                        <Target className="w-5 h-5 text-white" />
                      </div>
                      <h3 className="font-bold text-white text-lg">
                        Main Goal
                      </h3>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                      <p
                        className="text-white/90 text-sm leading-relaxed overflow-hidden"
                        style={{
                          display: "-webkit-box",
                          WebkitLineClamp: 3,
                          WebkitBoxOrient: "vertical",
                        }}
                      >
                        {userGoal
                          ? userGoal.length > 60
                            ? `${userGoal.substring(0, 60)}...`
                            : userGoal
                          : "사용자 목표를 분석 중입니다..."}
                      </p>
                    </div>
                  </div>

                  {/* Connection Arrow - Conditional Display */}
                  <div className={`${
                    layoutMode === 'vertical' 
                      ? 'flex items-center justify-center py-4' 
                      : 'hidden lg:flex items-center justify-center py-4'
                  }`}>
                    <div className="flex items-center space-x-2">
                      <div className="w-12 h-px bg-gradient-to-r from-primary to-indigo-400" />
                      <ArrowDown className={`w-5 h-5 text-indigo-400 ${
                        layoutMode === 'vertical' ? '' : 'rotate-90'
                      }`} />
                      <div className="w-12 h-px bg-gradient-to-r from-indigo-400 to-purple-400" />
                    </div>
                  </div>

                  {/* Subtasks Container - Loading state */}
                  <div className="flex-1">
                    <div className="bg-muted/30 border-2 border-dashed border-muted-foreground/40 rounded-3xl p-4 sm:p-8 backdrop-blur-sm min-h-[400px] h-full">
                      <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                            <Sparkles className="w-5 h-5 text-white" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold text-foreground">
                              Sub Tasks
                            </h3>
                            <p className="text-sm text-muted-foreground">
                              AI가 최적의 작업을 분석 중...
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Loading animation for subtasks only */}
                      <div className="flex flex-col items-center justify-center py-20 space-y-4">
                        <div className="w-16 h-16 border-4 border-indigo-200 dark:border-indigo-800 rounded-full animate-spin border-t-indigo-500"></div>
                        <p className="text-lg font-medium text-muted-foreground">
                          서브태스크 생성중...
                        </p>
                        <p className="text-sm text-muted-foreground text-center max-w-md">
                          AI가 최적의 워크플로우를 분석하고 있습니다
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Empty State */}
            {!isLoading && !workflowResult && (
              <div className="flex flex-col items-center justify-center py-12 sm:py-16 lg:py-20 space-y-6 sm:space-y-8">
                <div className="w-24 h-24 bg-gradient-to-br from-primary/20 to-primary/30 rounded-3xl flex items-center justify-center shadow-xl">
                  <Target className="w-12 h-12 text-primary" />
                </div>
                <div className="text-center space-y-3 sm:space-y-4">
                  <h2 className="text-xl sm:text-2xl lg:text-3xl font-bold text-foreground">
                    Start Your Workflow
                  </h2>
                  <p className="text-muted-foreground max-w-md text-base sm:text-lg px-4 sm:px-0">
                    Enter your goal in the form above and AI will design the
                    optimal workflow for you.
                  </p>
                </div>
              </div>
            )}

            {/* Workflow Canvas */}
            {!isLoading && workflowResult && (
              <div className="space-y-8">
                {/* Dynamic Layout: Main Node + Subtask Container */}
                <div className={`flex gap-8 items-start ${
                  layoutMode === 'vertical' 
                    ? 'flex-col' 
                    : 'flex-col lg:flex-row'
                }`}>
                  {/* Main Task Node */}
                  <div className={`bg-gradient-to-br from-primary to-primary/80 rounded-2xl p-4 sm:p-6 shadow-2xl border border-primary/20 w-full ${
                    layoutMode === 'vertical' ? 'max-w-none' : 'max-w-sm'
                  }`}>
                    <div className="flex items-center space-x-3 mb-3">
                      <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                        <Target className="w-5 h-5 text-white" />
                      </div>
                      <h3 className="font-bold text-white text-lg">
                        Main Goal
                      </h3>
                    </div>
                    <div className="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                      <p
                        className="text-white/90 text-sm leading-relaxed overflow-hidden"
                        style={{
                          display: "-webkit-box",
                          WebkitLineClamp: 3,
                          WebkitBoxOrient: "vertical",
                        }}
                      >
                        {userGoal
                          ? userGoal.length > 60
                            ? `${userGoal.substring(0, 60)}...`
                            : userGoal
                          : "사용자 목표를 분석 중입니다..."}
                      </p>
                    </div>
                  </div>

                  {/* Subtasks and Guide View Container - Vertical Layout Only */}
                  {layoutMode === 'vertical' ? (
                    <div className="flex flex-col lg:flex-row gap-8 w-full">
                      {/* Subtasks Container */}
                      <div className="flex-1">
                        <div className="bg-muted/30 border-2 border-dashed border-muted-foreground/40 rounded-3xl p-4 sm:p-8 backdrop-blur-sm min-h-[400px] h-full">
                          <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center space-x-3">
                              <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                                <Sparkles className="w-5 h-5 text-white" />
                              </div>
                              <div>
                                <h3 className="text-xl font-bold text-foreground">
                                  Sub Tasks
                                </h3>
                                <p className="text-sm text-muted-foreground">
                                  {workflowResult.tasks.length} optimized steps
                                </p>
                              </div>
                            </div>
                            <div className="flex items-center space-x-3">
                              <Button
                                onClick={() => setIsAddingTask(true)}
                                size="sm"
                                variant="outline"
                                className="border-primary/30 text-primary hover:bg-primary/10"
                              >
                                <Plus className="w-4 h-4 mr-1" />
                                Add Task
                              </Button>
                              <div className="bg-primary/10 text-primary px-4 py-2 rounded-full font-medium shadow-sm">
                                {getProgressPercentage()}% Complete
                              </div>
                            </div>
                          </div>

                          {/* Subtask Nodes - Vertical Layout */}
                          {workflowResult && workflowResult.status === "completed" ? (
                            <div className="flex flex-col gap-6">
                              {workflowResult.tasks.map((task, index) => (
                                <div key={task.id} className="relative">
                                  {/* Subtask Node */}
                                  <div
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, task.id)}
                                    onDragOver={(e) => handleDragOver(e, task.id)}
                                    onDragLeave={handleDragLeave}
                                    onDrop={(e) => handleDrop(e, task.id)}
                                    onClick={() => handleTaskClick(task.id)}
                                    className={`group bg-card border rounded-xl p-5 shadow-lg transition-all duration-200 cursor-pointer ${
                                      draggedTask === task.id
                                        ? "opacity-50 scale-105 border-primary shadow-2xl"
                                        : dragOverTask === task.id
                                        ? "border-primary border-2 shadow-xl scale-105"
                                        : selectedTask === task.id && layoutMode === 'vertical'
                                        ? "border-primary border-2 shadow-xl bg-primary/5"
                                        : "border-border hover:shadow-xl hover:scale-[1.02]"
                                    }`}
                                  >
                                    <div className="flex items-start space-x-4">
                                      <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg flex-shrink-0">
                                        {task.order}
                                      </div>
                                      <div className="flex-1 min-w-0">
                                        <div className="flex items-center justify-between mb-2">
                                          {editingTask === task.id ? (
                                            <div className="flex items-center space-x-2 flex-1">
                                              <Input
                                                value={editingText}
                                                onChange={(e) =>
                                                  setEditingText(e.target.value)
                                                }
                                                className="flex-1 text-sm"
                                                onKeyDown={(e) => {
                                                  if (e.key === "Enter")
                                                    handleEditSave();
                                                  if (e.key === "Escape")
                                                    handleEditCancel();
                                                }}
                                                autoFocus
                                              />
                                              <Button
                                                size="sm"
                                                variant="ghost"
                                                onClick={handleEditSave}
                                                className="p-1 h-auto"
                                              >
                                                <Check className="w-4 h-4 text-green-600" />
                                              </Button>
                                              <Button
                                                size="sm"
                                                variant="ghost"
                                                onClick={handleEditCancel}
                                                className="p-1 h-auto"
                                              >
                                                <X className="w-4 h-4 text-red-600" />
                                              </Button>
                                            </div>
                                          ) : (
                                            <>
                                              <h4 className="font-semibold text-foreground text-base leading-tight flex-1">
                                                {task.name}
                                              </h4>
                                              <div className="flex items-center space-x-1">
                                                <Button
                                                  size="sm"
                                                  variant="ghost"
                                                  onClick={() =>
                                                    handleRematchTool(
                                                      task.id,
                                                      task.name
                                                    )
                                                  }
                                                  className="p-1 h-auto opacity-0 group-hover:opacity-100 transition-opacity"
                                                  disabled={rematchingTasks.has(
                                                    task.id
                                                  )}
                                                >
                                                  {rematchingTasks.has(task.id) ? (
                                                    <Loader2 className="w-4 h-4 animate-spin text-muted-foreground" />
                                                  ) : (
                                                    <RefreshCw className="w-4 h-4 text-muted-foreground hover:text-blue-600" />
                                                  )}
                                                </Button>
                                                <Button
                                                  size="sm"
                                                  variant="ghost"
                                                  onClick={() =>
                                                    handleEditStart(
                                                      task.id,
                                                      task.name
                                                    )
                                                  }
                                                  className="p-1 h-auto opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                  <Edit3 className="w-4 h-4 text-muted-foreground hover:text-primary" />
                                                </Button>
                                                <Button
                                                  size="sm"
                                                  variant="ghost"
                                                  onClick={() =>
                                                    handleDeleteTask(task.id)
                                                  }
                                                  className="p-1 h-auto opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                  <Trash2 className="w-4 h-4 text-muted-foreground hover:text-red-600" />
                                                </Button>
                                                <GripVertical className="w-5 h-5 text-muted-foreground/50 hover:text-muted-foreground transition-colors cursor-grab active:cursor-grabbing" />
                                              </div>
                                            </>
                                          )}
                                        </div>

                                        {task.recommendedTool && (
                                          <div className="bg-muted/50 border rounded-lg p-3 mt-2">
                                            <div className="flex items-center justify-between">
                                              <div className="flex items-center space-x-2">
                                                {task.recommendedTool.logoUrl && (
                                                  <img
                                                    src={
                                                      task.recommendedTool.logoUrl
                                                    }
                                                    alt={task.recommendedTool.name}
                                                    className="w-5 h-5 rounded object-cover"
                                                    onError={(e) => {
                                                      const target =
                                                        e.target as HTMLImageElement;
                                                      target.style.display = "none";
                                                    }}
                                                  />
                                                )}
                                                <span className="text-sm font-medium text-foreground">
                                                  {task.recommendedTool.name}
                                                </span>
                                              </div>
                                              <div className="flex items-center space-x-2">
                                                {(() => {
                                                  const guideStatus = generatedGuides.get(task.id);
                                                  if (guideStatus?.status === "completed") {
                                                    return (
                                                      <div className="flex items-center space-x-1 text-xs text-emerald-600">
                                                        <CheckCircle2 className="w-3 h-3" />
                                                        <span>Guide Ready</span>
                                                      </div>
                                                    );
                                                  }
                                                  if (guideStatus?.status === "generating") {
                                                    return (
                                                      <div className="flex items-center space-x-1 text-xs text-blue-600">
                                                        <Loader2 className="w-3 h-3 animate-spin" />
                                                        <span>Generating...</span>
                                                      </div>
                                                    );
                                                  }
                                                  if (guideStatus?.status === "error") {
                                                    return (
                                                      <div className="flex items-center space-x-1 text-xs text-red-600">
                                                        <AlertCircle className="w-3 h-3" />
                                                        <span>Error</span>
                                                      </div>
                                                    );
                                                  }
                                                  return null;
                                                })()}
                                                <Button
                                                  onClick={() =>
                                                    window.open(
                                                      task.recommendedTool!.url,
                                                      "_blank"
                                                    )
                                                  }
                                                  size="sm"
                                                  variant="outline"
                                                  className="text-xs px-2 py-1 h-auto"
                                                >
                                                  <ExternalLink className="w-3 h-3 mr-1" />
                                                  Use
                                                </Button>
                                              </div>
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  </div>

                                  {/* Connection Lines between subtasks */}
                                  {index < workflowResult.tasks.length - 1 && (
                                    <div className="flex items-center justify-center py-4">
                                      <ArrowDown className="w-6 h-6 text-indigo-400" />
                                    </div>
                                  )}
                                </div>
                              ))}

                              {/* Add New Task - Vertical Layout */}
                              {isAddingTask && (
                                <div className="bg-card border-2 border-dashed border-primary/40 rounded-xl p-5 shadow-lg">
                                  <div className="flex items-center space-x-4">
                                    <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg flex-shrink-0">
                                      +
                                    </div>
                                    <div className="flex-1 space-y-3">
                                      <Input
                                        value={newTaskText}
                                        onChange={(e) =>
                                          setNewTaskText(e.target.value)
                                        }
                                        placeholder="새 작업 이름을 입력하세요..."
                                        className="w-full"
                                        onKeyDown={(e) => {
                                          if (e.key === "Enter") handleAddTask();
                                          if (e.key === "Escape")
                                            setIsAddingTask(false);
                                        }}
                                        autoFocus
                                      />
                                      <div className="flex items-center space-x-2">
                                        <Button
                                          size="sm"
                                          onClick={handleAddTask}
                                          disabled={!newTaskText.trim()}
                                          className="bg-green-600 hover:bg-green-700 text-white"
                                        >
                                          <Check className="w-4 h-4 mr-1" />
                                          Add Task
                                        </Button>
                                        <Button
                                          size="sm"
                                          variant="outline"
                                          onClick={() => {
                                            setIsAddingTask(false);
                                            setNewTaskText("");
                                          }}
                                        >
                                          <X className="w-4 h-4 mr-1" />
                                          Cancel
                                        </Button>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          ) : workflowResult && workflowResult.status !== "completed" ? (
                            <div className="flex flex-col items-center justify-center py-20 space-y-4">
                              <div className="w-16 h-16 border-4 border-indigo-200 dark:border-indigo-800 rounded-full animate-spin border-t-indigo-500"></div>
                              <p className="text-lg font-medium text-muted-foreground">
                                서브태스크 생성중...
                              </p>
                              <p className="text-sm text-muted-foreground text-center max-w-md">
                                AI가 최적의 워크플로우를 분석하고 있습니다
                              </p>
                            </div>
                          ) : null}
                        </div>
                      </div>

                      {/* Guide View Container */}
                      <div className="flex-1">
                        <div className="bg-muted/30 border-2 border-dashed border-muted-foreground/40 rounded-3xl p-4 sm:p-8 backdrop-blur-sm min-h-[400px] h-full">
                          <div className="flex items-center space-x-3 mb-6">
                            <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-xl flex items-center justify-center shadow-lg">
                              <BookOpen className="w-5 h-5 text-white" />
                            </div>
                            <div>
                              <h3 className="text-xl font-bold text-foreground">
                                Task Guide
                              </h3>
                              <p className="text-sm text-muted-foreground">
                                Detailed implementation guide
                              </p>
                            </div>
                          </div>

                          {/* Guide Content */}
                          {isGeneratingGuides ? (
                            /* Loading State */
                            <div className="flex flex-col items-center justify-center py-16 space-y-4">
                              <div className="w-16 h-16 border-4 border-emerald-200 dark:border-emerald-800 rounded-full animate-spin border-t-emerald-500"></div>
                              <div className="text-center space-y-2">
                                <h4 className="text-lg font-medium text-foreground">
                                  Generating guides...
                                </h4>
                                <p className="text-sm text-muted-foreground max-w-xs">
                                  AI is creating detailed implementation guides for each task.
                                </p>
                              </div>
                              <div className="text-xs text-muted-foreground">
                                {Array.from(generatedGuides.values()).filter(g => g.status === "completed").length} / {workflowResult?.tasks.length || 0} completed
                              </div>
                            </div>
                          ) : selectedTask && generatedGuides.has(selectedTask) ? (
                            /* Selected Task Guide */
                            (() => {
                              const guide = generatedGuides.get(selectedTask);
                              const task = workflowResult?.tasks.find(t => t.id === selectedTask);
                              
                              if (!guide || !task) return null;

                              if (guide?.status === "error") {
                                return (
                                  <div className="flex flex-col items-center justify-center py-16 space-y-4">
                                    <div className="w-16 h-16 bg-gradient-to-br from-red-100 to-red-200 dark:from-red-900/30 dark:to-red-800/30 rounded-2xl flex items-center justify-center">
                                      <AlertCircle className="w-8 h-8 text-red-600 dark:text-red-400" />
                                    </div>
                                    <div className="text-center space-y-2">
                                      <h4 className="text-lg font-medium text-foreground">
                                        Guide generation failed
                                      </h4>
                                      <p className="text-sm text-red-600 dark:text-red-400 max-w-xs">
                                        {guide?.error || 'Unknown error occurred'}
                                      </p>
                                    </div>
                                    <Button 
                                      onClick={() => retryGuideGeneration(selectedTask)}
                                      variant="outline"
                                      size="sm"
                                      disabled={guide?.status === "generating"}
                                    >
                                      {guide?.status === "generating" ? (
                                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                      ) : (
                                        <RefreshCw className="w-4 h-4 mr-2" />
                                      )}
                                      Retry
                                    </Button>
                                  </div>
                                );
                              }

                              if (guide?.status === "generating") {
                                return (
                                  <div className="flex flex-col items-center justify-center py-16 space-y-4">
                                    <div className="w-16 h-16 border-4 border-emerald-200 dark:border-emerald-800 rounded-full animate-spin border-t-emerald-500"></div>
                                    <div className="text-center space-y-2">
                                      <h4 className="text-lg font-medium text-foreground">
                                        Generating guide for {task.name}
                                      </h4>
                                      <div className="w-32 h-2 bg-muted rounded-full overflow-hidden">
                                        <div 
                                          className="h-full bg-emerald-500 transition-all duration-300"
                                          style={{ width: `${guide?.progress || 0}%` }}
                                        />
                                      </div>
                                      <p className="text-xs text-muted-foreground">
                                        {guide?.progress || 0}% complete
                                      </p>
                                    </div>
                                  </div>
                                );
                              }

                              if (guide?.status === "completed" && guide?.guide) {
                                return (
                                  <div className="space-y-4">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center space-x-2">
                                        <CheckCircle2 className="w-5 h-5 text-emerald-600" />
                                        <h4 className="text-lg font-medium text-foreground">
                                          {task.name}
                                        </h4>
                                      </div>
                                      {task.recommendedTool && (
                                        <Button
                                          onClick={() => window.open(task.recommendedTool!.url, "_blank")}
                                          size="sm"
                                          variant="outline"
                                        >
                                          <ExternalLink className="w-4 h-4 mr-2" />
                                          Open Tool
                                        </Button>
                                      )}
                                    </div>
                                    <div className="prose prose-sm max-w-none dark:prose-invert">
                                      <div 
                                        className="space-y-4 text-sm leading-relaxed"
                                        dangerouslySetInnerHTML={{ 
                                          __html: (guide?.guide || '')
                                            .replace(/\n/g, '<br>')
                                            .replace(/^## (.*$)/gim, '<h3 class="text-base font-semibold text-foreground mt-4 mb-2">$1</h3>')
                                            .replace(/^# (.*$)/gim, '<h2 class="text-lg font-bold text-foreground mt-6 mb-3">$1</h2>')
                                            .replace(/^\* (.*$)/gim, '<li class="ml-4">$1</li>')
                                            .replace(/^(\d+)\. (.*$)/gim, '<div class="flex items-start space-x-2 my-2"><span class="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-medium">$1</span><span>$2</span></div>')
                                        }}
                                      />
                                    </div>
                                  </div>
                                );
                              }

                              return null;
                            })()
                          ) : (
                            /* Empty State - No Task Selected */
                            <div className="flex flex-col items-center justify-center py-16 space-y-4">
                              <div className="w-16 h-16 bg-gradient-to-br from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 rounded-2xl flex items-center justify-center">
                                <FileText className="w-8 h-8 text-emerald-600 dark:text-emerald-400" />
                              </div>
                              <div className="text-center space-y-2">
                                <h4 className="text-lg font-medium text-foreground">
                                  {generatedGuides.size > 0 ? "Select a task to view its guide" : "Generate guides first"}
                                </h4>
                                <p className="text-sm text-muted-foreground max-w-xs">
                                  {generatedGuides.size > 0 
                                    ? "Choose a task from the left to see detailed implementation steps and recommendations."
                                    : "Click 'Generate Detailed Guides' to create AI-powered implementation guides for each task."
                                  }
                                </p>
                              </div>
                              {generatedGuides.size === 0 && (
                                <div className="flex items-center space-x-2 text-xs text-muted-foreground">
                                  <Star className="w-4 h-4" />
                                  <span>AI-powered guides available</span>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Horizontal Layout - Original Subtasks Container */}
                  {layoutMode === 'horizontal' && (
                    <div className="flex-1">
                      <div className="bg-muted/30 border-2 border-dashed border-muted-foreground/40 rounded-3xl p-4 sm:p-8 backdrop-blur-sm min-h-[400px] h-full">
                        <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                            <Sparkles className="w-5 h-5 text-white" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold text-foreground">
                              Sub Tasks
                            </h3>
                            <p className="text-sm text-muted-foreground">
                              {workflowResult.tasks.length} optimized steps
                            </p>
                          </div>
                        </div>
                        <div className="flex items-center space-x-3">
                          <Button
                            onClick={() => setIsAddingTask(true)}
                            size="sm"
                            variant="outline"
                            className="border-primary/30 text-primary hover:bg-primary/10"
                          >
                            <Plus className="w-4 h-4 mr-1" />
                            Add Task
                          </Button>
                          <div className="bg-primary/10 text-primary px-4 py-2 rounded-full font-medium shadow-sm">
                            {getProgressPercentage()}% Complete
                          </div>
                        </div>
                      </div>

                      {/* Subtask Nodes */}
                      {workflowResult &&
                      workflowResult.status === "completed" ? (
                        <div className={`gap-6 ${
                          layoutMode === 'vertical' 
                            ? 'flex flex-col' 
                            : 'grid grid-cols-1 lg:grid-cols-2'
                        }`}>
                          {workflowResult.tasks.map((task, index) => (
                            <div key={task.id} className="relative">
                              {/* Subtask Node */}
                              <div
                                draggable
                                onDragStart={(e) => handleDragStart(e, task.id)}
                                onDragOver={(e) => handleDragOver(e, task.id)}
                                onDragLeave={handleDragLeave}
                                onDrop={(e) => handleDrop(e, task.id)}
                                onClick={() => handleTaskClick(task.id)}
                                className={`group bg-card border rounded-xl p-5 shadow-lg transition-all duration-200 cursor-pointer ${
                                  draggedTask === task.id
                                    ? "opacity-50 scale-105 border-primary shadow-2xl"
                                    : dragOverTask === task.id
                                    ? "border-primary border-2 shadow-xl scale-105"
                                    : selectedTask === task.id && layoutMode === 'vertical'
                                    ? "border-primary border-2 shadow-xl bg-primary/5"
                                    : "border-border hover:shadow-xl hover:scale-[1.02]"
                                }`}
                              >
                                <div className="flex items-start space-x-4">
                                  <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg flex-shrink-0">
                                    {task.order}
                                  </div>
                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-center justify-between mb-2">
                                      {editingTask === task.id ? (
                                        <div className="flex items-center space-x-2 flex-1">
                                          <Input
                                            value={editingText}
                                            onChange={(e) =>
                                              setEditingText(e.target.value)
                                            }
                                            className="flex-1 text-sm"
                                            onKeyDown={(e) => {
                                              if (e.key === "Enter")
                                                handleEditSave();
                                              if (e.key === "Escape")
                                                handleEditCancel();
                                            }}
                                            autoFocus
                                          />
                                          <Button
                                            size="sm"
                                            variant="ghost"
                                            onClick={handleEditSave}
                                            className="p-1 h-auto"
                                          >
                                            <Check className="w-4 h-4 text-green-600" />
                                          </Button>
                                          <Button
                                            size="sm"
                                            variant="ghost"
                                            onClick={handleEditCancel}
                                            className="p-1 h-auto"
                                          >
                                            <X className="w-4 h-4 text-red-600" />
                                          </Button>
                                        </div>
                                      ) : (
                                        <>
                                          <h4 className="font-semibold text-foreground text-base leading-tight flex-1">
                                            {task.name}
                                          </h4>
                                          <div className="flex items-center space-x-1">
                                            <Button
                                              size="sm"
                                              variant="ghost"
                                              onClick={() =>
                                                handleRematchTool(
                                                  task.id,
                                                  task.name
                                                )
                                              }
                                              className="p-1 h-auto opacity-0 group-hover:opacity-100 transition-opacity"
                                              disabled={rematchingTasks.has(
                                                task.id
                                              )}
                                            >
                                              {rematchingTasks.has(task.id) ? (
                                                <Loader2 className="w-4 h-4 animate-spin text-muted-foreground" />
                                              ) : (
                                                <RefreshCw className="w-4 h-4 text-muted-foreground hover:text-blue-600" />
                                              )}
                                            </Button>
                                            <Button
                                              size="sm"
                                              variant="ghost"
                                              onClick={() =>
                                                handleEditStart(
                                                  task.id,
                                                  task.name
                                                )
                                              }
                                              className="p-1 h-auto opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                              <Edit3 className="w-4 h-4 text-muted-foreground hover:text-primary" />
                                            </Button>
                                            <Button
                                              size="sm"
                                              variant="ghost"
                                              onClick={() =>
                                                handleDeleteTask(task.id)
                                              }
                                              className="p-1 h-auto opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                              <Trash2 className="w-4 h-4 text-muted-foreground hover:text-red-600" />
                                            </Button>
                                            <GripVertical className="w-5 h-5 text-muted-foreground/50 hover:text-muted-foreground transition-colors cursor-grab active:cursor-grabbing" />
                                          </div>
                                        </>
                                      )}
                                    </div>

                                    {task.recommendedTool && (
                                      <div className="bg-muted/50 border rounded-lg p-3 mt-2">
                                        <div className="flex items-center justify-between">
                                          <div className="flex items-center space-x-2">
                                            {task.recommendedTool.logoUrl && (
                                              <img
                                                src={
                                                  task.recommendedTool.logoUrl
                                                }
                                                alt={task.recommendedTool.name}
                                                className="w-5 h-5 rounded object-cover"
                                                onError={(e) => {
                                                  const target =
                                                    e.target as HTMLImageElement;
                                                  target.style.display = "none";
                                                }}
                                              />
                                            )}
                                            <span className="text-sm font-medium text-foreground">
                                              {task.recommendedTool.name}
                                            </span>
                                          </div>
                                          <div className="flex items-center space-x-2">
                                            {(() => {
                                              const guideStatus = generatedGuides.get(task.id);
                                              if (guideStatus?.status === "completed") {
                                                return (
                                                  <div className="flex items-center space-x-1 text-xs text-emerald-600">
                                                    <CheckCircle2 className="w-3 h-3" />
                                                    <span>Guide Ready</span>
                                                  </div>
                                                );
                                              }
                                              if (guideStatus?.status === "generating") {
                                                return (
                                                  <div className="flex items-center space-x-1 text-xs text-blue-600">
                                                    <Loader2 className="w-3 h-3 animate-spin" />
                                                    <span>Generating...</span>
                                                  </div>
                                                );
                                              }
                                              if (guideStatus?.status === "error") {
                                                return (
                                                  <div className="flex items-center space-x-1 text-xs text-red-600">
                                                    <AlertCircle className="w-3 h-3" />
                                                    <span>Error</span>
                                                  </div>
                                                );
                                              }
                                              return null;
                                            })()}
                                            <Button
                                              onClick={() =>
                                                window.open(
                                                  task.recommendedTool!.url,
                                                  "_blank"
                                                )
                                              }
                                              size="sm"
                                              variant="outline"
                                              className="text-xs px-2 py-1 h-auto"
                                            >
                                              <ExternalLink className="w-3 h-3 mr-1" />
                                              Use
                                            </Button>
                                          </div>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>

                              {/* Connection Lines between subtasks */}
                              {index < workflowResult.tasks.length - 1 &&
                                index % 2 === 0 && (
                                  <div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 lg:hidden">
                                    <ArrowDown className="w-6 h-6 text-indigo-400" />
                                  </div>
                                )}
                            </div>
                          ))}

                          {/* Add New Task */}
                          {isAddingTask && (
                            <div className="bg-card border-2 border-dashed border-primary/40 rounded-xl p-5 shadow-lg">
                              <div className="flex items-center space-x-4">
                                <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg flex-shrink-0">
                                  +
                                </div>
                                <div className="flex-1 space-y-3">
                                  <Input
                                    value={newTaskText}
                                    onChange={(e) =>
                                      setNewTaskText(e.target.value)
                                    }
                                    placeholder="새 작업 이름을 입력하세요..."
                                    className="w-full"
                                    onKeyDown={(e) => {
                                      if (e.key === "Enter") handleAddTask();
                                      if (e.key === "Escape")
                                        setIsAddingTask(false);
                                    }}
                                    autoFocus
                                  />
                                  <div className="flex items-center space-x-2">
                                    <Button
                                      size="sm"
                                      onClick={handleAddTask}
                                      disabled={!newTaskText.trim()}
                                      className="bg-green-600 hover:bg-green-700 text-white"
                                    >
                                      <Check className="w-4 h-4 mr-1" />
                                      Add Task
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => {
                                        setIsAddingTask(false);
                                        setNewTaskText("");
                                      }}
                                    >
                                      <X className="w-4 h-4 mr-1" />
                                      Cancel
                                    </Button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      ) : workflowResult &&
                        workflowResult.status !== "completed" ? (
                        <div className="flex flex-col items-center justify-center py-20 space-y-4">
                          <div className="w-16 h-16 border-4 border-indigo-200 dark:border-indigo-800 rounded-full animate-spin border-t-indigo-500"></div>
                          <p className="text-lg font-medium text-muted-foreground">
                            서브태스크 생성중...
                          </p>
                          <p className="text-sm text-muted-foreground text-center max-w-md">
                            AI가 최적의 워크플로우를 분석하고 있습니다
                          </p>
                        </div>
                      ) : null}
                      </div>
                    </div>
                  )}
                </div>

                {/* Completion Celebration */}
                {getProgressPercentage() === 100 && (
                  <div className="mt-8">
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 border border-green-200 dark:border-green-700 rounded-2xl p-6 shadow-2xl backdrop-blur-sm">
                      <div className="flex flex-col sm:flex-row sm:items-center justify-between space-y-4 sm:space-y-0">
                        <div className="flex items-center space-x-4">
                          <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                            <CheckCircle2 className="w-6 h-6 text-white" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold text-green-900 dark:text-green-100">
                              Planning Complete!
                            </h3>
                            <p className="text-green-700 dark:text-green-300">
                              All {workflowResult.tasks.length} steps have been
                              successfully mapped.
                            </p>
                          </div>
                        </div>
                        <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                          <Button
                            onClick={handleProceedToGuides}
                            disabled={isGeneratingGuides}
                            className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 disabled:opacity-70 disabled:scale-100"
                          >
                            {isGeneratingGuides ? (
                              <>
                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                Generating Guides...
                              </>
                            ) : (
                              <>
                                <BookOpen className="w-4 h-4 mr-2" />
                                Generate Detailed Guides
                              </>
                            )}
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
